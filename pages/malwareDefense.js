document.addEventListener('DOMContentLoaded', () => {
    const quickBtn = document.getElementById('md-quick');
    const fullBtn = document.getElementById('md-full');
    const folderBtn = document.getElementById('md-folder-btn');
    const folderInput = document.getElementById('md-folder-input');

    const output = document.getElementById('md-output');
    const loader = document.getElementById('md-loader');

    // Add these two elements to your HTML inside #malware-defense if not present
    const status = document.createElement('p');
    status.id = 'md-status';
    status.style.marginTop = '10px';
    status.style.fontStyle = 'italic';
    status.style.color = '#c5e2df';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Save Output';
    saveBtn.className = 'action';
    saveBtn.style.marginTop = '10px';
    saveBtn.disabled = true;

    document.querySelector('#malware-defense').appendChild(status);
    document.querySelector('#malware-defense').appendChild(saveBtn);

    const updateStatus = (msg) => {
        const time = new Date().toLocaleTimeString();
        status.textContent = `[${time}] ${msg}`;
    };

    const runScan = async (mode, target = null) => {
        const emptyState = document.getElementById('md-empty');
        if (emptyState) {
            emptyState.style.display = 'none'; // hide image if it's there
        }

        saveBtn.classList.add('hidden'); // hide save button before scan starts
        loader.classList.remove('hidden');
        loader.textContent = ''; // reset any previous icon
        output.textContent = '';
        updateStatus(`Running ${mode} scan...`);

        try {
            const result = await window.defenderAPI.run(mode, target);

            loader.classList.add('hidden');
            loader.textContent = '✅';
            updateStatus(`${mode} scan complete.`);

            let threats;
            try {
                threats = JSON.parse(result);
            } catch {
                output.innerHTML = `<div class="no-threats">✅ Scan complete, no threat data available.</div>`;
                saveBtn.classList.remove('hidden'); // show button even if no threat JSON
                return;
            }

            if (Array.isArray(threats) && threats.length > 0) {
                output.innerHTML = threats.map(t => `
                <div class="threat-box">
                    <strong>${t.ThreatName}</strong><br>
                    Severity: <span class="sev">${t.Severity}</span><br>
                    Action Success: ${t.ActionSuccess ? '✅' : '❌'}
                </div>
            `).join('');
            } else {
                output.innerHTML = `<div class="no-threats">✅ No active threats detected.</div>`;
            }

            // ✅ Show save button after successful result
            saveBtn.classList.remove('hidden');

        } catch (err) {
            loader.classList.add('hidden');
            loader.textContent = '❌';
            output.innerHTML = `<span style="color:tomato;">❌ Scan failed:</span>\n` + err.message;
            updateStatus(`${mode} scan failed.`);
        }
    };


    quickBtn?.addEventListener('click', () => runScan('quick'));
    fullBtn?.addEventListener('click', () => runScan('full'));

    folderBtn?.addEventListener('click', () => folderInput?.click());
    folderInput?.addEventListener('change', () => {
        const files = folderInput.files;
        if (files.length > 0) {
            const folderPath = files[0].path;
            runScan('folder', folderPath);
        }
    });

    // Save output to file
    saveBtn?.addEventListener('click', () => {
        const blob = new Blob([output.textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `defender-scan-${Date.now()}.txt`;
        a.click();
    });
});
