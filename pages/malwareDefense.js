// pages/malwareDefense.js
export function init() {
    console.log('ðŸ”§ malwareDefense.init()');

    // â”€â”€â”€ GLOBAL ID LOOKUPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const container = document.getElementById('malware-defense');
    const quickBtn = document.getElementById('md-quick');
    const fullBtn = document.getElementById('md-full');
    const folderBtn = document.getElementById('md-folder-btn');
    const folderInput = document.getElementById('md-folder-input');
    const output = document.getElementById('md-output');
    const progressWrap = document.querySelector('#malware-defense .progress-container');
    const progressFill = document.querySelector('#malware-defense .progress-fill');

    console.log('  refs â†’', {
        quickBtn: !!quickBtn,
        fullBtn: !!fullBtn,
        folderBtn: !!folderBtn,
        folderIn: !!folderInput,
        progWrap: !!progressWrap,
        progFill: !!progressFill
    });

    // â”€â”€â”€ PROGRESS HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startProgress(duration) {
        console.log('â–¶ï¸ startProgress(', duration, ')');
        container.classList.add('md-scanning');
        progressWrap.classList.remove('hidden');
        progressFill.style.animation = 'none';
        void progressFill.offsetWidth;
        progressFill.style.animation = `fillProgress ${duration} linear forwards`;
    }
    function stopProgress() {
        console.log('â¹ï¸ stopProgress');
        container.classList.remove('md-scanning');
        progressWrap.classList.add('hidden');
    }

    // â”€â”€â”€ CORE SCAN LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleMode(mode, target) {
        console.log('ðŸŸ¢ handleMode(', mode, target, ')');
        output.textContent = '';
        container.classList.add('loading');

        startProgress('2s');  // instant starter

        let secs = 30;
        try {
            secs = await window.defenderAPI.getScanEstimate(mode, target);
            console.log('ðŸ“ estimatedSecs =', secs);
        } catch (e) {
            console.warn('âš ï¸ estimate failed:', e);
        }
        startProgress(`${secs}s`);

        try {
            const res = mode === 'folder'
                ? await window.defenderAPI.run('folder', target)
                : await window.defenderAPI.run(mode);
            console.log('âœ… scan result:', res.trim());
        } catch (err) {
            console.error('âŒ scan failed:', err);
        }

        progressFill.addEventListener('animationend', () => {
            console.log('ðŸŽ¬ animationend');
            stopProgress();
            output.textContent = 'âœ… Scan complete!';
            container.classList.remove('loading');
        }, { once: true });
    }

    // â”€â”€â”€ BUTTON WIRING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function attach(mode, btn) {
        console.log('  attach:', mode, btn);
        if (!btn) {
            console.warn(`   â†’ no element for mode "${mode}"`);
            return;
        }
        btn.addEventListener('click', () => {
            console.log(`ðŸ‘‡ button click: ${mode}`);
            if (mode === 'folder') folderInput.click();
            else handleMode(mode);
        });
    }
    attach('quick', quickBtn);
    attach('full', fullBtn);
    attach('folder', folderBtn);

    // â”€â”€â”€ FOLDER PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    folderInput.addEventListener('change', () => {
        const file = folderInput.files[0];
        console.log('ðŸ“‚ folder selected:', file && file.path);
        if (file) handleMode('folder', file.path);
    });
}
