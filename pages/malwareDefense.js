document.addEventListener('DOMContentLoaded', () => {
    const quickBtn = document.getElementById('md-quick');
    const fullBtn = document.getElementById('md-full');
    const folderBtn = document.getElementById('md-folder-btn');
    const folderInput = document.getElementById('md-folder-input');

    const output = document.getElementById('md-output');
    const loader = document.getElementById('md-loader');

    // Add these two elements to your HTML inside #malware-defense if not present
    const status = document.createElement('p');
    status.id = 'md-status';
    status.style.marginTop = '10px';
    status.style.fontStyle = 'italic';
    status.style.color = '#c5e2df';

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Save Output';
    saveBtn.className = 'action';
    saveBtn.style.marginTop = '10px';
    saveBtn.disabled = true;

    document.querySelector('#malware-defense').appendChild(status);
    document.querySelector('#malware-defense').appendChild(saveBtn);

    const updateStatus = (msg) => {
        const time = new Date().toLocaleTimeString();
        status.textContent = `[${time}] ${msg}`;
    };

    const runScan = async (mode, target = null) => {
        const output = document.getElementById('md-output');
        const loader = document.getElementById('md-loader');
        const status = document.getElementById('md-status');
        const emptyState = document.getElementById('md-empty');

        if (emptyState) {
            emptyState.style.display = 'none';
        }

        loader.classList.remove('hidden');
        loader.textContent = '';
        output.innerHTML = '';
        status.textContent = `[${new Date().toLocaleTimeString()}] Running ${mode} scan...`;

        try {
            const result = await window.defenderAPI.run(mode, target);

            loader.classList.add('hidden');
            loader.textContent = '✅';
            status.textContent = `[${new Date().toLocaleTimeString()}] ${mode} scan complete.`;

            let threats;
            try {
                threats = JSON.parse(result);
            } catch {
                output.innerHTML = `<div class="no-threats">✅ Scan complete, no threat data available.</div>`;
                return;
            }

            if (Array.isArray(threats) && threats.length > 0) {
                output.innerHTML = `
                <div class="summary-box">
                    ⚠️ <strong>${threats.length} threat${threats.length > 1 ? 's' : ''} found</strong>
                </div>
                ` + threats.map(t => `
                <div class="threat-box">
                    <strong>${t.ThreatName}</strong><br>
                    Severity: <span class="sev">${t.Severity}</span><br>
                    Action: ${t.ActionSuccess ? '✅ Successful' : '❌ Failed'}
                </div>
            `).join('');
            } else {
                output.innerHTML = `<div class="no-threats">✅ No active threats detected.</div>`;
            }

        } catch (err) {
            loader.classList.add('hidden');
            loader.textContent = '❌';
            output.innerHTML = `<span style="color:tomato;">❌ Scan failed:</span><br>${err.message}`;
            status.textContent = `[${new Date().toLocaleTimeString()}] Scan failed.`;
        }
    };



    quickBtn?.addEventListener('click', () => runScan('quick'));
    fullBtn?.addEventListener('click', () => runScan('full'));

    folderBtn?.addEventListener('click', () => folderInput?.click());
    folderInput?.addEventListener('change', () => {
        const files = folderInput.files;
        if (files.length > 0) {
            const folderPath = files[0].path;
            runScan('folder', folderPath);
        }
    });

    // Save output to file
    saveBtn?.addEventListener('click', () => {
        const blob = new Blob([output.textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `defender-scan-${Date.now()}.txt`;
        a.click();
    });
});
